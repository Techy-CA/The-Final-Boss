// Firebase init
const firebaseConfig = {
  apiKey: "AIzaSyBFWCCiw-9_8gsBaXoJ1RxMEL89lvyOIho",
  authDomain: "the-final-boss-notes.firebaseapp.com",
  projectId: "the-final-boss-notes",
  storageBucket: "the-final-boss-notes.appspot.com",
  messagingSenderId: "319601095052",
  appId: "1:319601095052:web:691823298ab7c1826f66a9",
  measurementId: "G-CVCSSCXMCB",
};
firebase.initializeApp(firebaseConfig);

const auth = firebase.auth();
const db   = firebase.firestore();

// Elements
const logoutBtn      = document.getElementById('logoutBtn');
const loginSection   = document.getElementById('loginSection');
const adminSection   = document.getElementById('adminSection');
const loginForm      = document.getElementById('loginForm');
const loginMessage   = document.getElementById('loginMessage');

const noteForm       = document.getElementById('noteForm');
const formMessage    = document.getElementById('formMessage');
const cancelEditBtn  = document.getElementById('cancelEditBtn');
const notesListEl    = document.getElementById('notesList');
const notesCountEl   = document.getElementById('notesCount');

// form fields
const fTitle     = document.getElementById('noteTitle');
const fSubject   = document.getElementById('noteSubject');
const fSemester  = document.getElementById('noteSemester');
const fFaculty   = document.getElementById('noteFaculty');
const fTags      = document.getElementById('noteTags');
const fFileSize  = document.getElementById('noteFileSize');
const fDriveLink = document.getElementById('noteDriveLink');

let isEditing = false;
let editingId = null;

// ---------- UI helpers ----------
function showLogin() {
  loginSection.classList.remove('hidden');
  adminSection.classList.add('hidden');
  logoutBtn.classList.add('hidden');
}

function showDashboard() {
  loginSection.classList.add('hidden');
  adminSection.classList.remove('hidden');
  logoutBtn.classList.remove('hidden');
}

function clearMessages() {
  loginMessage.textContent = '';
  formMessage.textContent = '';
  formMessage.className = 'message';
}

function resetForm() {
  noteForm.reset();
  isEditing = false;
  editingId = null;
  cancelEditBtn.classList.add('hidden');
  formMessage.textContent = '';
  formMessage.className = 'message';
}

// ---------- Auth state ----------
auth.onAuthStateChanged(user => {
  clearMessages();
  if (user) {
    showDashboard();
    loadNotes();
  } else {
    showLogin();
    notesListEl.innerHTML = '';
    notesCountEl.textContent = '0 notes';
  }
});

// ---------- Login ----------
loginForm.addEventListener('submit', e => {
  e.preventDefault();
  clearMessages();
  const email = loginForm.loginEmail.value.trim();
  const pass  = loginForm.loginPassword.value;

  if (!email || !pass) {
    loginMessage.textContent = 'Enter email and password.';
    loginMessage.className = 'message error';
    return;
  }

  auth.signInWithEmailAndPassword(email, pass)
    .then(() => {
      loginForm.reset();
      loginMessage.textContent = '';
    })
    .catch(err => {
      loginMessage.textContent = err.message;
      loginMessage.className = 'message error';
    });
});

// ---------- Logout ----------
logoutBtn.addEventListener('click', () => {
  auth.signOut();
});

// ---------- Load notes ----------
async function loadNotes() {
  notesListEl.innerHTML = '<div class="message">Loading notes...</div>';
  try {
    const snap = await db.collection('notes')
      .orderBy('uploadDate', 'desc')
      .get();

    const docs = snap.docs;
    notesCountEl.textContent = `${docs.length} notes`;

    if (!docs.length) {
      notesListEl.innerHTML = '<div class="message">No notes yet.</div>';
      return;
    }

    notesListEl.innerHTML = '';
    docs.forEach(doc => {
      const data = doc.data();
      const row  = document.createElement('div');
      row.className = 'note-row';
      row.innerHTML = `
        <div class="note-main">
          <div class="note-title-small" title="${data.title || ''}">
            ${data.title || '(no title)'}
          </div>
          <div class="note-meta">
            Sem ${data.semester || '-'} • ${data.subject || '-'} • ${data.faculty || '-'}
          </div>
        </div>
        <div class="note-actions">
          <button data-id="${doc.id}" class="editBtn">Edit</button>
          <button data-id="${doc.id}" class="danger deleteBtn">Delete</button>
        </div>
      `;
      notesListEl.appendChild(row);
    });

    // attach events
    notesListEl.querySelectorAll('.editBtn').forEach(btn =>
      btn.addEventListener('click', onEditClick)
    );
    notesListEl.querySelectorAll('.deleteBtn').forEach(btn =>
      btn.addEventListener('click', onDeleteClick)
    );

  } catch (err) {
    notesListEl.innerHTML = `<div class="message error">Error loading notes: ${err.message}</div>`;
  }
}

// ---------- Edit ----------
async function onEditClick(e) {
  const id = e.target.dataset.id;
  clearMessages();

  try {
    const doc = await db.collection('notes').doc(id).get();
    if (!doc.exists) {
      formMessage.textContent = 'Note not found.';
      formMessage.className = 'message error';
      return;
    }
    const d = doc.data();
    fTitle.value     = d.title || '';
    fSubject.value   = d.subject || '';
    fSemester.value  = d.semester || '';
    fFaculty.value   = d.faculty || '';
    fTags.value      = (d.tags || []).join(', ');
    fFileSize.value  = d.fileSize || '';
    fDriveLink.value = d.driveLink || '';

    isEditing = true;
    editingId = id;
    cancelEditBtn.classList.remove('hidden');
    formMessage.textContent = 'Editing existing note.';
    formMessage.className = 'message';
  } catch (err) {
    formMessage.textContent = 'Error opening note: ' + err.message;
    formMessage.className = 'message error';
  }
}

// ---------- Delete ----------
async function onDeleteClick(e) {
  const id = e.target.dataset.id;
  clearMessages();
  const ok = confirm('Delete this note permanently?');
  if (!ok) return;

  try {
    await db.collection('notes').doc(id).delete();
    formMessage.textContent = 'Note deleted.';
    formMessage.className = 'message success';
    if (isEditing && editingId === id) resetForm();
    loadNotes();
  } catch (err) {
    formMessage.textContent = 'Error deleting note: ' + err.message;
    formMessage.className = 'message error';
  }
}

// ---------- Cancel edit ----------
cancelEditBtn.addEventListener('click', e => {
  e.preventDefault();
  resetForm();
});

// ---------- Save (add / update) ----------
noteForm.addEventListener('submit', async e => {
  e.preventDefault();
  clearMessages();

  const title    = fTitle.value.trim();
  const subject  = fSubject.value.trim();
  const semester = fSemester.value;
  const faculty  = fFaculty.value.trim();
  const tags     = fTags.value.split(',')
                      .map(t => t.trim())
                      .filter(Boolean);
  const fileSize = fFileSize.value.trim();
  const drive    = fDriveLink.value.trim();

  if (!title || !subject || !semester || !faculty || !fileSize || !drive) {
    formMessage.textContent = 'Please fill all required fields.';
    formMessage.className = 'message error';
    return;
  }
  if (!drive.startsWith('http')) {
    formMessage.textContent = 'Enter a valid Google Drive link.';
    formMessage.className = 'message error';
    return;
  }

  const payload = {
    title,
    subject,
    semester,
    faculty,
    tags,
    fileSize,
    driveLink: drive,
    uploadDate: firebase.firestore.FieldValue.serverTimestamp(),
  };

  try {
    if (isEditing && editingId) {
      await db.collection('notes').doc(editingId).update(payload);
      formMessage.textContent = 'Note updated.';
    } else {
      await db.collection('notes').add(payload);
      formMessage.textContent = 'Note added.';
    }
    formMessage.className = 'message success';
    resetForm();
    loadNotes();
  } catch (err) {
    formMessage.textContent = 'Error saving note: ' + err.message;
    formMessage.className = 'message error';
  }
});
